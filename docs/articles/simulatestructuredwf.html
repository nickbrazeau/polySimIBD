<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Structured DTWF Malaria Simulator Overview • polySimIBD</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Structured DTWF Malaria Simulator Overview">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">polySimIBD</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/simulatestructuredwf.html">Structured DTWF Malaria Simulator Overview</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/nickbrazeau/polySimIBD">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Structured DTWF Malaria Simulator Overview</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/nickbrazeau/polySimIBD/blob/master/vignettes/simulatestructuredwf.Rmd"><code>vignettes/simulatestructuredwf.Rmd</code></a></small>
      <div class="hidden name"><code>simulatestructuredwf.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(polySimIBD)</span></code></pre></div>
<div id="purpose" class="section level1">
<h1 class="hasAnchor">
<a href="#purpose" class="anchor"></a>Purpose</h1>
<p>The purpose of the <code>polySimIBD</code> package is to perform forwards in-time simulation of malaria population genetics. The model uses a discrete-time, discrete-loci structured Wright Fisher approximation to account for (simplified) malaria transmission dynamics.</p>
</div>
<div id="a-brief-primer-on-malaria-genetics" class="section level1">
<h1 class="hasAnchor">
<a href="#a-brief-primer-on-malaria-genetics" class="anchor"></a>A Brief Primer on Malaria Genetics</h1>
<p>The need for a malaria-specific simulator is primarily due to the complex life-cycle of malaria and the phenomenon of multiple strains potentially infecting a single human host (“Complexity of Infection, or Multiplicity of Infection”). As part of the malaria life-cycle, parasite ploidy switches from haploid in the human host to diploid in the mosquito vector midgut. It is during this diploid stage that recombination occurs between parasites. However, not all recombination results in unique progeny, or unique haplotypes. For example, if only a single haplotype is present in the mosquite midgut (i.e. a monoclonal infection), all recombination events will “look” the same, as there is no variation for recombination to act upon. In contrast, if more than one haplotype is present in the mosquite midgut (i.e. a polyclonal infection), recombination will produce unique progeny.</p>
<p>In a similar framework, hosts can then be infected with monoclonal or polyclonal infections depending on the number of infectious bites they receive and the number of unique haplotypes within the mosquito vector at the time of the infectious bite. Polyclonal infections can result either from:</p>
<ol style="list-style-type: decimal">
<li>Multiple infectious bites transferring unique haplotypes (Superinfection)</li>
<li>A single infectious bite transferring multiple haplotypes (Co-Transmission)</li>
</ol>
<p align="center">
<img src="https://raw.githubusercontent.com/nickbrazeau/polySimIBD/master/R_ignore/images/cotransmission_superinfxn.png" title="fig:" width="500" alt="Schematic of the DL-DT sWF Malaria Model"></p>
</div>
<div id="a-very-very-brief-primer-on-the-coalescent" class="section level1">
<h1 class="hasAnchor">
<a href="#a-very-very-brief-primer-on-the-coalescent" class="anchor"></a>A <strong>very, very</strong> Brief Primer on the Coalescent</h1>
<p>Coalescent theory is one of the central pillars of population genetics and is a vast subject (see Wakeley’s classic textbook, Coalescent Theory: An Introduction). Essentially, coalescent theory provides a framework for how loci (genes, individuals, etc.) have been derived from a common ancestor backwards in time, classically using the assumptions of the Wright-Fisher model. One of the main assumptions of the coalescence, is that loci are independent and that no recombination is occuring between loci. To relax this assumption, we must consider the coalescence with recombination. In this framework, a single coalescent tree is no longer representative of gene (NB: gene has now been extended to genome on an interval [0, L], see <a href="http://lamastex.org/recomb/ima.pdf">Griffiths &amp; Marjoram 1996</a> for further details). Instead, each loci in the gene interval has a marignal tree due recombination resulting in different genealogical histories of loci. The collection of these trees with respect to recombination breakpoints among loci in the gene interval is termed the Ancestral Recombination Graph (ARG).</p>
<p align="center">
<img src="https://raw.githubusercontent.com/nickbrazeau/polySimIBD/master/R_ignore/images/arg.png" title="fig:" width="500" alt="ARG for Three Samples with Two Discrete Loci"></p>
</div>
<div id="model-formulation" class="section level1">
<h1 class="hasAnchor">
<a href="#model-formulation" class="anchor"></a>Model Formulation</h1>
<p>The full mathematical formulation of the model can be found in the Supplementary Section of <a href="https://www.biorxiv.org/content/10.1101/656561v1">Verity, Aydemic, Brazeau <em>et al.</em> 2019, Biorxiv</a>. As a brief lay summary, we assume that each individual host can be represented by a deme, or a subpopulation within a large population (<span class="math inline">\(i \in N\)</span>, where <span class="math inline">\(i\)</span> is an individual host and <span class="math inline">\(N\)</span> is the total host population). We then allow the <span class="math inline">\(J\)</span> parasites (that reside within the host population) to mate at random with the previous generation of parasites (<span class="math inline">\(t_{1-}\)</span>) and produce a large number of parasite progeny. During mating, genetic recombination has the potential to occur based on the length of the genome and the recombination rate, <span class="math inline">\(\rho\)</span>. Progeny are then allowed to migrate to a new or the same host with a probability of <span class="math inline">\(\frac{m}{N}\)</span>. Progeny are then culled down to a smaller number of parasites per host by drawing from a Poisson distribution with a mean COI (schematic below).</p>
<p align="center">
<img src="https://raw.githubusercontent.com/nickbrazeau/polySimIBD/master/R_ignore/images/sWFmodelframework.png" title="fig:" width="500" alt="Schematic of the DL-DT sWF Malaria Model"></p>
<p>As can be seen from the schematic, the user-specified probability of migration, <span class="math inline">\(m\)</span>, has an effect on whether or not the transmission dynamic favors Superinfection (“panmictic”) or Contransmission (“independent”) setting.</p>
</div>
<div id="simulating-data" class="section level1">
<h1 class="hasAnchor">
<a href="#simulating-data" class="anchor"></a>Simulating Data</h1>
<p>Users are able to specify loci positions, <code>pos</code>, the number of Hosts in the population, <code>N</code>, the probability of migration, <code>m</code>, the recombination rate, <code>rho</code>, and the Mean COI for host parasite burden (culling of the progeny), <code>mean_coi</code>. Finally, users have the option to let the model run forwards in time until all parasites have coalesced to a single common ancestor (<code>tlim = Inf</code>), or can set a limit on the number of generations that we simulate (<code>tlim = &lt;integer&gt;</code>).</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">1</span>)</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="co"># define parameters</span></span>
<span id="cb2-3"><a href="#cb2-3"></a>pos &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="dv">1</span>,<span class="fl">1e3</span>,<span class="fl">5e2</span>)</span>
<span id="cb2-4"><a href="#cb2-4"></a>N &lt;-<span class="st"> </span><span class="dv">10</span></span>
<span id="cb2-5"><a href="#cb2-5"></a>m &lt;-<span class="st"> </span><span class="fl">0.5</span></span>
<span id="cb2-6"><a href="#cb2-6"></a>rho &lt;-<span class="st"> </span><span class="fl">1e-3</span></span>
<span id="cb2-7"><a href="#cb2-7"></a>mean_coi &lt;-<span class="st"> </span><span class="dv">3</span></span>
<span id="cb2-8"><a href="#cb2-8"></a></span>
<span id="cb2-9"><a href="#cb2-9"></a>swfsim &lt;-<span class="st"> </span><span class="kw"><a href="../reference/sim_structured_WF.html">sim_structured_WF</a></span>(<span class="dt">pos =</span> pos,</span>
<span id="cb2-10"><a href="#cb2-10"></a>                            <span class="dt">N =</span> N, </span>
<span id="cb2-11"><a href="#cb2-11"></a>                            <span class="dt">m =</span> m,</span>
<span id="cb2-12"><a href="#cb2-12"></a>                            <span class="dt">rho =</span> rho, </span>
<span id="cb2-13"><a href="#cb2-13"></a>                            <span class="dt">mean_coi =</span> mean_coi,</span>
<span id="cb2-14"><a href="#cb2-14"></a>                            <span class="dt">tlim =</span> <span class="ot">Inf</span>)</span></code></pre></div>
<p>The discrete-loci, discrete-time structured Wright Fisher simulation outputs three objets: 1. A vector of COIs, where each item in the vector is the number of parasites within that host 2. A list that contains two matrices that correspond to the Ancestries for each parasite 3. A vector of loci positions</p>
</div>
<div id="getting-the-arg" class="section level1">
<h1 class="hasAnchor">
<a href="#getting-the-arg" class="anchor"></a>Getting the ARG</h1>
<p>Using the ancestry matrices, we can derive the most recent common ancestor (MRCA) and the time of MRCA coalescent event for each parasite (“terminal node”) at each discrete loci. By deriving the MRCA and the timing of each coalescent event at each discrete loci, we are able to recreate the marginal tree for each loci and store the entire ancestral recombination graph.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>ARG &lt;-<span class="st"> </span><span class="kw"><a href="../reference/get_ARG.html">get_ARG</a></span>(swfsim, <span class="dt">parasites =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>))</span></code></pre></div>
</div>
<div id="visualizing-the-simulation" class="section level1">
<h1 class="hasAnchor">
<a href="#visualizing-the-simulation" class="anchor"></a>Visualizing the Simulation</h1>
<p>Here, we will visualize the maringal tree for each loci. Users are able to specify which loci to visualize. Of note, you will only be able to visualize the marginal trees for the parasites that you created the ARG for in the previous section.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw"><a href="../reference/plot_coalescence_trees.html">plot_coalescence_trees</a></span>(ARG, <span class="dt">loci =</span> <span class="dv">1</span>)</span></code></pre></div>
<p><img src="simulatestructuredwf_files/figure-html/unnamed-chunk-4-1.png" width="576" style="display: block; margin: auto;"></p>
</div>
<div id="adding-mutations" class="section level1">
<h1 class="hasAnchor">
<a href="#adding-mutations" class="anchor"></a>Adding Mutations</h1>
<p>Finally, we can layer mutations on to each marginal tree (and the overall ARG) based on the total branch length of the coalescent tree and the user specificed per-recombination block mutation rate.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>hapmat &lt;-<span class="st"> </span>polySimIBD<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/polySimIBD/man/layer_mutations_on_ARG.html">layer_mutations_on_ARG</a></span>(ARG, <span class="dt">mutationrate =</span> <span class="fl">0.1</span>)</span>
<span id="cb5-2"><a href="#cb5-2"></a>hapmat &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="dt">POS =</span> swfsim<span class="op">$</span>pos, hapmat)</span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="kw"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(hapmat) &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"POS"</span>, <span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"parasite"</span>, ARG<span class="op">$</span>parasites))</span>
<span id="cb5-4"><a href="#cb5-4"></a>knitr<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>(hapmat)</span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">POS</th>
<th align="right">parasite1</th>
<th align="right">parasite2</th>
<th align="right">parasite3</th>
<th align="right">parasite4</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="right">501</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">2</td>
</tr>
</tbody>
</table>
<div id="closing-digressions" class="section level2">
<h2 class="hasAnchor">
<a href="#closing-digressions" class="anchor"></a>Closing Digressions</h2>
<p>You may have noticed that our coalescent trees (<code>bvtree</code> class) always coalesce “right”. This is intentional and an approach to optimize looping through ancestries to get the ARG. As a result, remember that not every intersection is a true node (e.g. lines can “jump” over other lines).</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#purpose">Purpose</a></li>
      <li><a href="#a-brief-primer-on-malaria-genetics">A Brief Primer on Malaria Genetics</a></li>
      <li><a href="#a-very-very-brief-primer-on-the-coalescent">A <strong>very, very</strong> Brief Primer on the Coalescent</a></li>
      <li><a href="#model-formulation">Model Formulation</a></li>
      <li><a href="#simulating-data">Simulating Data</a></li>
      <li><a href="#getting-the-arg">Getting the ARG</a></li>
      <li><a href="#visualizing-the-simulation">Visualizing the Simulation</a></li>
      <li>
<a href="#adding-mutations">Adding Mutations</a><ul class="nav nav-pills nav-stacked">
<li><a href="#closing-digressions">Closing Digressions</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Nick Brazeau, Bob Verity.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
